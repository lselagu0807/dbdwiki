<div class="fondo">

  <div class="dbd-carousel-container" [class.detail-active]="isDetailView">

    <!-- â”€â”€ CARRUSEL â”€â”€ -->
    <div class="arc-viewport" [class.shifted]="isDetailView">
      @for (item of visibleSurvivors; track item.data.code) {
        <div class="survivor-item"
             [ngStyle]="getTransform(item.position)"
             [class.is-center]="item.position === 0"
             [class.is-selected]="isDetailView && item.position === 0"
             (click)="item.position === 0 && !isDetailView ? openDetail(item.data) : rotate(item.position)">

          <div class="portrait-wrapper shadow">
            <img [src]="item.data.imgs.store" class="img-fluid" [alt]="item.data.name">
          </div>

          @if (item.position === 0 && !isDetailView) {
            <div class="survivor-info text-center mt-2">
              <h5 class="text-white text-uppercase mb-0 fw-bold">{{ item.data.name }}</h5>
              <small class="text-secondary">{{ item.data.role }}</small>
            </div>
          }
        </div>
      }
    </div>

    <!-- â”€â”€ NAVEGACIÃ“N â”€â”€ -->
    <div class="navigation" [class.hidden]="isDetailView">
      <button class="btn btn-outline-light btn-sm" (click)="rotate(1)">&#10094;</button>
      <button class="btn btn-outline-light btn-sm" (click)="rotate(-1)">&#10095;</button>
    </div>

    <!-- â”€â”€ OVERLAY â”€â”€ -->
    @if (isDetailView) {
      <div class="detail-overlay" (click)="closeDetail()"></div>
    }

    <!-- â”€â”€ MODAL DETALLE SURVIVOR â”€â”€ -->
    @if (selectedSurvivor) {
      <div class="detail-modal" [class.active]="isDetailView">

        <div class="modal-header">
          <div class="survivor-title">
            <h2 class="text-white text-uppercase mb-1">{{ selectedSurvivor.name }}</h2>
            <p class="text-secondary mb-2">{{ selectedSurvivor.role }}</p>
            <div class="survivor-badges">
              <span class="badge-custom bg-danger">{{ selectedSurvivor.difficulty }}</span>
              <span class="badge-custom bg-secondary">{{ selectedSurvivor.nationality }}</span>
              @if (selectedSurvivor.licensed) {
                <span class="badge-custom bg-warning">De licencia</span>
              }
            </div>
          </div>
          <button class="btn-close-modal" (click)="closeDetail()">
            <span>&times;</span>
          </button>
        </div>

        <div class="modal-body">

          @if (selectedSurvivor.overview) {
            <div class="info-section">
              <h5 class="section-title"><span class="title-icon">ðŸ“–</span> Resumen</h5>
              <p class="section-content">{{ selectedSurvivor.overview }}</p>
            </div>
          }

          <div class="info-section">
            <h5 class="section-title"><span class="title-icon">âš¡</span> Ventajas Ãšnicas</h5>

            @if (isLoadingPerks) {
              <div class="loading-perks">
                <div class="spinner-border spinner-border-sm text-danger" role="status"></div>
                <span class="text-white-50 ms-2">Cargando ventajas...</span>
              </div>
            } @else if (survivorPerks && survivorPerks.length > 0) {
              <div class="perks-container">
                @for (perk of survivorPerks; track perk.id) {
                  <div class="perk-box">
                    <div class="perk-image">
                      <img [src]="perk.icon" [alt]="perk.name">
                    </div>
                    <div class="perk-details">
                      <h6 class="perk-name">{{ perk.name }}</h6>
                      <p class="perk-description">{{ perk.description }}</p>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <p class="text-white-50">No hay ventajas disponibles</p>
            }
          </div>

        </div>
      </div>
    }

  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CATÃLOGO PAGINADO
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="perks-catalog-container" [class.hidden]="isDetailView">
    <h2 class="text-center text-uppercase mb-4">Perks de los Survivors</h2>

    <!-- â†“ BUSCADOR CONECTADO: (input) llama a onSearch, [value] muestra el estado actual -->
    <div class="search-container">
      <input
        type="text"
        class="search-input"
        placeholder="Buscar por perk, descripciÃ³n o survivor..."
        [value]="searchQuery"
        (input)="onSearch($any($event.target).value)">
    </div>

    <!-- Skeletons mientras carga -->
    @if (allPerks.length === 0) {
      <div class="perks-diamond-grid">
        @for (s of [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]; track s) {
          <div class="perk-diamond-item">
            <div class="diamond-shape skeleton-diamond"></div>
            <div class="perk-label-container">
              <span class="skeleton-text"></span>
              <span class="skeleton-text small"></span>
            </div>
          </div>
        }
      </div>

    <!-- Sin resultados -->
    } @else if (filteredPerks.length === 0) {
      <div class="no-results">
        <p class="text-white-50">No se encontraron perks para <strong class="text-white">"{{ searchQuery }}"</strong></p>
      </div>

    } @else {

      <!-- â†“ pagedPerks usa filteredPerks internamente -->
      <div class="perks-diamond-grid">
        @for (perk of pagedPerks; track $index) {
          <div class="perk-diamond-item" (click)="openPerkModal(perk)">
            <div class="diamond-shape">
              <img [src]="perk.icon" [alt]="perk.name">
            </div>
            <div class="perk-label-container">
              <span class="perk-name-text">{{ perk.name }}</span>
              <small class="perk-owner-text">{{ perk.ownerName }}</small>
            </div>
          </div>
        }
      </div>

      <!-- PaginaciÃ³n â€” solo si hay mÃ¡s de una pÃ¡gina -->
      @if (totalPages > 1) {
        <div class="pagination-container">

          <button class="page-btn" (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">
            &#10094;
          </button>

          @if (pageNumbers[0] > 1) {
            <button class="page-btn" (click)="goToPage(1)">1</button>
            @if (pageNumbers[0] > 2) {
              <span class="page-info">â€¦</span>
            }
          }

          @for (page of pageNumbers; track page) {
            <button class="page-btn" [class.active]="page === currentPage" (click)="goToPage(page)">
              {{ page }}
            </button>
          }

          @if (pageNumbers[pageNumbers.length - 1] < totalPages) {
            @if (pageNumbers[pageNumbers.length - 1] < totalPages - 1) {
              <span class="page-info">â€¦</span>
            }
            <button class="page-btn" (click)="goToPage(totalPages)">{{ totalPages }}</button>
          }

          <button class="page-btn" (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">
            &#10095;
          </button>

          <span class="page-info">{{ currentPage }} / {{ totalPages }}</span>
        </div>
      }

    }
  </div>

  <!-- â”€â”€ MODAL DETALLE PERK â”€â”€ -->
  @if (showPerkModal) {
    <div class="perk-modal-overlay" [class.closing]="isClosing" (click)="closePerkModal()">
      <div class="perk-modal-content" (click)="$event.stopPropagation()">
        <button class="btn-close-modal-perk" (click)="closePerkModal()">&times;</button>
        <div class="modal-perk-header">
          <div class="diamond-shape small">
            <img [src]="selectedPerk?.icon" alt="">
          </div>
          <h4>{{ selectedPerk?.name }}</h4>
        </div>
        <hr class="perk-divider">
        <div class="modal-perk-body">
          <p [innerHTML]="selectedPerk?.description"></p>
          <small class="perk-owner-text">{{ selectedPerk?.ownerName }}</small>
        </div>
      </div>
    </div>
  }

</div>